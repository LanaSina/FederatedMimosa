<!DOCTYPE html>
<html lang="en">
<head>
<title>Federated Mimosa</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
  font-family: Arial, Helvetica, sans-serif;
}

.hierarchy{
  transform: translate(100px,50px);
  padding: 1em;
}
.comment{
  color: grey;
  padding: 1em;
}

</style>
</head>
<body>

<h1>Fediprint for ALife2023: Self-Replication, Spontaneous Mutations, and Exponential Genetic Drift in Neural Cellular Automata</h1>

<label for="fediUrl">Url of the post to reformat</label>
<input type="text" id="fediUrl" name="Url" required size="50" value="https://mstdn.science/@lana/110354052667093132">
<button type='button' id='urlButton' onclick='fetchFediversePost()'> Go </button>


<div id="mastoStatus"></div>
<div id='descendants0'>
  <div id='hierarchies0'></div>
  <div id='comments0'></div>
</div>


<script>
function httpGetAsync(theUrl, callback, divID) {
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.onreadystatechange = function() { 
        if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
            callback(xmlHttp.responseText, divID);
    }
    xmlHttp.open("GET", theUrl, true); // true for asynchronous 
    xmlHttp.send(null);
}


function fetchFediversePost(){
  const theUrl = document.getElementById("fediUrl").value
  console.log(theUrl)
  // parse for id
  const words = theUrl.split('/');
  const postId = words[words.length-1]
  new httpGetAsync('https://mstdn.science/api/v1/statuses/' + postId , parseMastoStatus)
}


function fetchComments(statusID, divID) {
  apiUrl = 'https://mstdn.science/api/v1/statuses/' + statusID + '/context' 
  new httpGetAsync(apiUrl, parseComments, divID)
}


function parseComments(requestResult, divID){
  // todo make this global
  var hierTag = "&gt;"
  const plusTag = "+"

  var jStatus= JSON.parse(requestResult);
  console.log(jStatus)
  var finalText = ""

  for (let i = 0; i < jStatus.descendants.length; i++) {
    descendant = jStatus.descendants[i]
    console.log(descendant)
    // check that it is not a reblog
    if (descendant.content != ""){
      // check if ia a comment
      if (!descendant.content.includes(hierTag) & !descendant.content.includes(plusTag)){
        elementContent = "<div class='comment'>"
        elementContent = elementContent + htmlFormatStatus(descendant) 
        elementContent = elementContent + "</div>\n"
        finalText += elementContent
      } 
    }
  }

  document.getElementById(divID).innerHTML = finalText;
}


function fetchHierarchy(statusID, divID) {
  apiUrl = 'https://mstdn.science/api/v1/statuses/' + statusID + '/context' 
  new httpGetAsync(apiUrl, parseHierarchy, divID)
}


function parseHierarchy(requestResult, divID){
  const hierTag = "&gt;"
  const plusTag = "+"
  const jStatus= JSON.parse(requestResult);
  console.log(jStatus)
  var finalText = ""

  // parse hierarchy level from div id
  level = parseInt(divID.slice(-1)) + 1
  hDiv = 'hierarchies' + level
  cDiv = 'comments' + level

  for (let i = 0; i < jStatus.descendants.length; i++) {
    descendant = jStatus.descendants[i]
    // console.log(descendant)
    // check that it is not a reblog
    if (descendant.content != ""){
      // check if is a hierarchy
      // cannot just take 1st char as mastodon adds <p>...
      if (descendant.content.includes(hierTag)){
        elementContent = "<div class='hierarchy'>"
        elementContent = elementContent + " " + htmlFormatStatus(descendant)
        // button to display comments
        elementContent = elementContent + "<br>" + getShowCommentsButton(descendant.id, level) + "<br>"
        //to do add level here
        elementContent = elementContent + "<div id='descendants'> <div id='"
                       + hDiv 
                       + "'></div> <div id='"
                       + cDiv 
                       + "'></div></div>"
        elementContent = elementContent + "</div>"
        finalText += elementContent
      } else if(descendant.content.includes(plusTag)){
        // todo check if the user is "allowed" to do that

        finalText =  finalText + htmlFormatStatus(descendant)
      }
    }
  }

    document.getElementById(divID).innerHTML = finalText;
}


function htmlFormatStatus(jStatus){
  var finalText = jStatus.content
  // look for images
  if (jStatus.media_attachments.length>0){
    for (let i = 0; i < jStatus.media_attachments.length; i++) {
      attachment = jStatus.media_attachments[i]
      if (attachment.type=="image"){
        finalText += "\n<img src='" + attachment.url + "' alt='" + attachment.description + "' >"
      }
    }
    
  }

  return finalText
}


function parseMastoStatus(s) {
  var jStatus= JSON.parse(s);
  //console.log(jStatus)
  document.getElementById('mastoStatus').innerHTML = htmlFormatStatus(jStatus);

  const theUrl = document.getElementById("fediUrl").value
  // parse for id
  const words = theUrl.split('/');
  const postId = words[words.length-1]

  fetchAllDescendants(postId, 0)
}


function getShowCommentsButton(statusID, level){
  var htmlText = ""
  htmlText = htmlText + "<button type='button'"
           + "onclick='fetchAllDescendants(\"" + "110337557170602617" + "\"," + level + ")'>" 
           + "Show hierarchy and comments.</button>"

  return htmlText
}


function fetchAllDescendants(statusID, level){
  hDiv = 'hierarchies' + level
  cDiv = 'comments' + level
  fetchHierarchy(statusID, hDiv)
  fetchComments(statusID, cDiv)
}


// new httpGetAsync('https://mstdn.science/api/v1/statuses/110337557170602617/', parseMastoStatus)
// fetchAllDescendants('110337557170602617', 0)


</script>

</body>
</html>