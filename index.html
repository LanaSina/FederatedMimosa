<!DOCTYPE html>
<html lang="en">
<head>
<title>Federated Mimosa</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
  font-family: Arial, Helvetica, sans-serif;
}

.hierarchy{
  width: 100%;
  padding: 1em;
  padding-left: 5em;
  box-sizing: border-box;
}
.comment{
  color: grey;
  padding-left: 1em;
}
#main-wrapper {
  width: 100%;
  box-sizing: border-box;
}

</style>
</head>
<body>

<h1>Fediprint for ALife2023: Self-Replication, Spontaneous Mutations, and Exponential Genetic Drift in Neural Cellular Automata</h1>

<label for="fediUrl">Url of the post to reformat</label>
<input type="text" id="fediUrl" name="Url" required size="50" value="https://mstdn.science/@lana/110354052667093132">
<button type='button' id='urlButton' onclick='fetchFediversePost()'> Go </button>


<div id="main-wrapper">
  <div id="mastoStatus"></div>
  <div id="wholeTree"></div>
</div>

<script>
function httpGetAsync(theUrl, callback, divID) {
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.onreadystatechange = function() { 
        if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
            callback(xmlHttp.responseText, divID);
    }
    xmlHttp.open("GET", theUrl, true); // true for asynchronous 
    xmlHttp.send(null);
}


function fetchFediversePost(){
  const theUrl = document.getElementById("fediUrl").value
  console.log(theUrl)
  // parse for id
  const words = theUrl.split('/');
  const postId = words[words.length-1]
  new httpGetAsync('https://mstdn.science/api/v1/statuses/' + postId , parseMastoStatus)
}


function fetchHierarchy(statusID, divID) {
  apiUrl = 'https://mstdn.science/api/v1/statuses/' + statusID + '/context' 
  //new httpGetAsync(apiUrl, parseHierarchy, divID)
  new httpGetAsync(apiUrl, createDivTree, divID)
}


function createDivTree(requestResult, divID){
  const jStatus= JSON.parse(requestResult);
  const hierTag = "&gt;"
  const plusTag = "+"
  divRoot = document.getElementById(divID)

  // Create divs for all known children.
  for (let i = 0; i < jStatus.descendants.length; i++) {
    descendant = jStatus.descendants[i]
    

    // if the status is >, add it as child
    if (descendant.content.includes(hierTag)){
      let innerDiv = formatStatusDiv(descendant, "child")
      // create root div of this hierarchy
      // find appropriate place, the container of the parent
      let divParent = document.getElementById(descendant.in_reply_to_id).parentNode
      let divHierarchy = document.createElement('div')
      divHierarchy.classList.add("hierarchy")
      divHierarchy.style.display = "none"
      // hide/show button for the parent (todo deal with parent that has several children)
      const showButton = getShowButton(divHierarchy)
      
      
      // comments div for show comments button
      const commentDivId = "comments" + descendant.id
      let divComments = document.createElement('div')
      divComments.id = commentDivId
      divComments.style.display = "none"
      // create show comments button
      const showCommentButtonId = "showComments" + descendant.id
      let showCommentsButton = getShowCommentsButton(divComments)
      showCommentsButton.id = showCommentButtonId
      showCommentsButton.hidden = "hidden"
      // add to container of parent
      innerDiv.appendChild(showCommentsButton)
      innerDiv.appendChild(divComments)

      // append show hierarchy button
      divParent.appendChild(showButton)
      // then append hierarchy
      divParent.appendChild(divHierarchy)
      // add the content to hierarchy
      divHierarchy.appendChild(innerDiv)
    } else if (descendant.content.includes(plusTag)){
      // if the status is + add it to the parent 
      let divParent = document.getElementById(descendant.in_reply_to_id).parentNode
      let innerDiv = formatStatusDiv(descendant, "add")

      
      // comments div for show comments button
      const commentDivId = "comments" + descendant.id
      let divComments = document.createElement('div')
      divComments.id = commentDivId
      divComments.style.display = "none"
      // create show comments button
      const showCommentButtonId = "showComments" + descendant.id
      let showCommentsButton = getShowCommentsButton(divComments)
      showCommentsButton.id = showCommentButtonId
      showCommentsButton.hidden = "hidden"
      // add to container of parent
      innerDiv.appendChild(showCommentsButton)
      innerDiv.appendChild(divComments)


      divParent.appendChild(innerDiv)
    } else {
      // those are comments      
      
      // the parent of the div right before
      let divParent = document.getElementById(descendant.in_reply_to_id)
      let divComments = null
      let divCommentsIDNumber = 0
      if(divParent.classList.contains("comment")){
        // get the comment container, not the comment itself
        divComments = divParent.parentNode
        divCommentsIDNumber = divParent.parentNode.parentNode.id
      } else {
        //get the correct child
        const commentDivId = "comments" + divParent.id
        divComments = document.getElementById(commentDivId)
        divCommentsIDNumber = divParent.id
      }

      console.log(divCommentsIDNumber)

      // make button visible
      const showCommentButtonId = "showComments" + divCommentsIDNumber
      let showCommentsButton = document.getElementById(showCommentButtonId)
      showCommentsButton.hidden = null


      let innerDiv = formatStatusDiv(descendant, "comment")
      innerDiv.classList.add("comment") 
      divComments.appendChild(innerDiv)
    }
    
  }

}

function getShowButton(hierarchyDiv){
  var showButton = document.createElement("button");
  showButton.innerHTML = 'Show hierarchy';
  showButton.onclick = function(){  
    if (hierarchyDiv.style.display === "none") {
      hierarchyDiv.style.display = "block";
      showButton.innerHTML = 'Hide hierarchy';
    } else {
      hierarchyDiv.style.display = "none";
      showButton.innerHTML = 'Show hierarchy';
    }
  }

  return showButton
}


function getShowCommentsButton(hierarchyDiv){
  var showButton = document.createElement("button");
  showButton.innerHTML = 'Show comments';
  showButton.onclick = function(){  
    if (hierarchyDiv.style.display === "none") {
      hierarchyDiv.style.display = "block";
      showButton.innerHTML = 'Hide comments';
    } else {
      hierarchyDiv.style.display = "none";
      showButton.innerHTML = 'Show comments';
    }
  }

  return showButton
}


function formatStatusDiv(jStatus, type){
  let divStatus = document.createElement('div')
  divStatus.innerHTML = jStatus.content
  divStatus.id = jStatus.id


  // look for images
  if (jStatus.media_attachments.length>0){
    for (let i = 0; i < jStatus.media_attachments.length; i++) {
      attachment = jStatus.media_attachments[i]
      if (attachment.type=="image"){
        if (type != "comment"){
          let img = document.createElement('img')
          img.src = attachment.url 
          img.alt = attachment.description
          img.style.maxWidth = "100%"
          divStatus.appendChild(img)
        } else{
          // this is in a comment
          let span = document.createElement('span')
          let a = document.createElement('a')
          a.setAttribute('href', attachment.url)
          a_innerHTML = "image" 
          if(attachment.description != null){
            a_innerHTML = a_innerHTML + ": " + attachment.description
          }
          a.innerHTML = a_innerHTML + "&nbsp;"
          span.appendChild(a)
          divStatus.appendChild(span)
        }
      }
    }  
  }

  // look for videos
  if(jStatus.card != null){
    if(isVideo(jStatus.card.url)){
      if (type != "comment"){
        const embedUrl = jStatus.card.url.split("&")[0].replace("watch?v=", "embed/")
        console.log(embedUrl)
        let videoFrame = embedVideo(embedUrl)
        divStatus.appendChild(videoFrame)
      } else {
        // this is in a comment
        let span = document.createElement('span')
        let a = document.createElement('a')
        a.setAttribute('href', jStatus.card.url)
        a.innerHTML = "video    " 
        span.appendChild(a)
        divStatus.appendChild(span)
      }
    }
  }
  

  return divStatus
}



function embedVideo(videoUrl){
  iframe = document.createElement('iframe');
  iframe.src = videoUrl
  iframe.width = "420" 
  iframe.height = "315"

  return iframe
}


function isVideo(urlText){
  if(urlText == null){
    return false
  }
  if (urlText.includes("https://www.youtube.com/watch") | urlText.includes("https://www.youtube.com/embed")){
    return true
  }

  return false
}


function parseMastoStatus(s) {
  var jStatus= JSON.parse(s);

  let innerDiv = formatStatusDiv(jStatus)
  document.getElementById('wholeTree').appendChild(innerDiv)

  const theUrl = document.getElementById("fediUrl").value
  // parse for id
  const words = theUrl.split('/');
  const postId = words[words.length-1]

  fetchAllDescendants(postId, 0)
}


function fetchAllDescendants(statusID, level){
  hDiv = 'hierarchies' + level
  cDiv = 'comments' + level
  fetchHierarchy(statusID, "wholeTree")
}

fetchFediversePost("https://mstdn.science/@lana/110354052667093132")

</script>

</body>
</html>